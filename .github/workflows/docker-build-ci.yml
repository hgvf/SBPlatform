name: CI - Docker Build & Smoke Test

# 觸發條件：當推送到 main 分支，或是發起 Pull Request 時
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # 設定 CI 執行的逾時時間 (避免卡住燒錢)
    timeout-minutes: 20

    steps:
      # 1. 下載你的程式碼
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 建立假的 .env 檔案
      # 因為 GitHub 上不應該有 .env，但 docker-compose 需要變數才能跑
      # 這裡填入測試用的假資料即可
      - name: Create dummy .env file
        run: |
          cat <<EOF > .env
          # Postgres
          POSTGRES_USER=test_user
          POSTGRES_PASSWORD=test_password
          POSTGRES_DB=test_db
          POSTGRES_PORT=5432
          
          # PGAdmin
          PGADMIN_EMAIL=admin@example.com
          PGADMIN_PASSWORD=admin
          PGADMIN_PORT=15432
          
          # InfluxDB
          INFLUX_USERNAME=admin
          INFLUX_PASSWORD=influx_password_123
          INFLUX_ORG=test_org
          INFLUX_BUCKET=test_bucket
          INFLUX_TOKEN=test_token_123
          INFLUXDB_UI_PORT=8086
          
          # Jupyter / Backtest
          JUPYTER_PORT=8888
          
          # Ports for Services
          OPENBB_PORT=8001
          ALGO_NEWS_PORT=8002
          ALGO_STRATEGY_PORT=8003
          
          # API Keys (使用假的不影響 Build，但如果程式啟動會檢查連線則會失敗)
          # 在 CI Build 階段，通常我們只測試 "能不能啟動"，不測試 "能不能連到 FRED"
          OPENBB_FRED_API_KEY=dummy_fred_key
          OPENBB_FMP_API_KEY=dummy_fmp_key
          EOF

      # 3. 設定 Docker Buildx (為了加快 Build 速度，啟用快取功能)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. 建置 Docker Images (Build)
      # 加上 --parallel 平行建置，加速編譯多個微服務
      - name: Build Docker Images
        run: docker compose build --parallel

      # 5. 啟動服務 (Smoke Test)
      # 確保容器不只 build 得過，還能跑得起來 (沒有語法錯誤或缺少 entrypoint)
      - name: Start Services
        run: docker compose up -d

      # 6. 等待 15 秒並檢查容器狀態
      # 有些容器會因為 Python 依賴沒裝好，啟動後 3 秒就 Crash
      # 這個步驟是用來抓出這種問題的
      - name: Check Container Health
        run: |
          echo "Waiting for services to initialize..."
          sleep 15
          
          echo "=== Container Status ==="
          docker compose ps
          
          echo "=== Check for Exited Containers ==="
          # 如果有任何容器狀態是 'Exited'，這行指令會讓 CI 報錯失敗
          if [ $(docker compose ps -q -f "status=exited" | wc -l) -gt 0 ]; then
            echo "❌ Some containers crashed!"
            docker compose ps -a
            docker compose logs
            exit 1
          else
            echo "✅ All containers are running!"
          fi

      # 7. (選用) 清理環境
      - name: Teardown
        if: always()
        run: docker compose down
